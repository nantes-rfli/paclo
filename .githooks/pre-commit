#!/usr/bin/env bash
set -euo pipefail

# === Optional flags (override via env vars) ===
: "${SKIP_TESTS:=0}"    # 1 = skip tests
: "${SKIP_FMT:=0}"      # 1 = skip formatting
: "${SKIP_MD_LINT:=0}"  # 1 = skip markdown lint

echo "[pre-commit] start"

# 1) tests
if [ "$SKIP_TESTS" -ne 1 ]; then
  echo "[pre-commit] Running tests..."
  clj -M:test
else
  echo "[pre-commit] SKIP_TESTS=1 -> skip tests"
fi

# 2) format (clojure-lsp clean-ns & format)
if [ "$SKIP_FMT" -ne 1 ]; then
  echo "[pre-commit] Formatting via clojure-lsp..."
  dev/script/fmt.sh
else
  echo "[pre-commit] SKIP_FMT=1 -> skip formatting"
fi

# 3) Markdown lint
if [ "$SKIP_MD_LINT" -ne 1 ]; then
  echo "[pre-commit] Markdown lint (markdownlint-cli2 via npx)..."
  if ! dev/script/mdlint.sh --fix; then
    echo "[pre-commit] markdownlint failed" >&2
    exit 1
  fi
else
  echo "[pre-commit] SKIP_MD_LINT=1 -> skip markdown lint"
fi

# 4) clj-kondo (with auto-fix where possible)
if [ "${SKIP_KONDO:-0}" -ne 1 ]; then
  echo "[pre-commit] clj-kondo lint (with --fix)..."
  dev/script/kondo.sh --fix
else
  echo "[pre-commit] SKIP_KONDO=1 -> skip clj-kondo"
fi

# 5) stage updates created by format/lint
git add -u

echo "[pre-commit] done"
