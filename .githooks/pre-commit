#!/usr/bin/env bash
set -euo pipefail

# === 可変フラグ（必要に応じて環境変数で上書き可能） ===
: "${SKIP_TESTS:=0}"    # 1 = テストを飛ばす
: "${SKIP_FMT:=0}"      # 1 = 整形を飛ばす
: "${SKIP_HANDOFF:=0}"  # 1 = AI_HANDOFF.md の再生成を飛ばす

echo "[pre-commit] start"

# 1) テスト
if [ "$SKIP_TESTS" -ne 1 ]; then
  echo "[pre-commit] Running tests..."
  clj -M:test
else
  echo "[pre-commit] SKIP_TESTS=1 -> skip tests"
fi

# 2) 整形（clojure-lsp clean-ns & format）
if [ "$SKIP_FMT" -ne 1 ]; then
  echo "[pre-commit] Formatting via clojure-lsp..."
  script/fmt.sh
else
  echo "[pre-commit] SKIP_FMT=1 -> skip formatting"
fi

# 3) AI_HANDOFF.md 再生成
if [ "$SKIP_HANDOFF" -ne 1 ]; then
  echo "[pre-commit] Regenerating AI_HANDOFF.md..."
  script/make-ai-handoff.sh
  git add AI_HANDOFF.md || true
else
  echo "[pre-commit] SKIP_HANDOFF=1 -> skip AI_HANDOFF generation"
fi

# 4) 整形による差分などを自動ステージ
git add -u

echo "[pre-commit] done"
